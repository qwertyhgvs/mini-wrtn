<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>mini-wrtn</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #0f172a, #020617);
      color: #f9fafb;
    }
    .app {
      width: 100%;
      max-width: 960px;
      background: rgba(15,23,42,0.9);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border: 1px solid rgba(148,163,184,0.4);
      backdrop-filter: blur(10px);
      display: flex;
      gap: 12px;
      min-height: 520px;
    }

    /* ì™¼ìª½: ì±„íŒ… ë¦¬ìŠ¤íŠ¸ */
    .sidebar {
      width: 230px;
      border-right: 1px solid rgba(51,65,85,0.8);
      padding-right: 10px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
    }
    .sidebar-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: rgba(148,163,184,0.2);
      color: #e5e7eb;
    }
    .sidebar-btn:hover {
      background: rgba(148,163,184,0.35);
    }
    .chat-list {
      list-style: none;
      margin: 0;
      padding: 0;
      flex: 1;
      overflow-y: auto;
      font-size: 13px;
    }
    .chat-item {
      padding: 6px 8px;
      border-radius: 8px;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .chat-item.active {
      background: linear-gradient(135deg, #1d4ed8, #22c55e);
      color: #0f172a;
    }
    .chat-item-title {
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-item-snippet {
      font-size: 11px;
      opacity: 0.8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar-footer {
      margin-top: 6px;
      font-size: 10px;
      color: #9ca3af;
    }

    /* ì˜¤ë¥¸ìª½: ë©”ì¸ ì±„íŒ… ì˜ì—­ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .logo {
      font-weight: 700;
      font-size: 20px;
    }
    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
    }
    .mode-select {
      margin-bottom: 8px;
      font-size: 14px;
      color: #e5e7eb;
    }
    .mode-select label {
      margin-right: 10px;
      cursor: pointer;
    }
    #log {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid rgba(51,65,85,0.8);
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.4;
    }
    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    #msg {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: #020617;
      color: #f9fafb;
      outline: none;
    }
    #msg:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.5);
    }
    button.send-btn {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #0f172a;
      min-width: 80px;
    }

    /* ë¡œë”© */
    .loading-indicator {
      margin-top: 4px;
      font-size: 12px;
      color: #9ca3af;
      min-height: 16px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .loading-indicator.hidden {
      visibility: hidden;
    }
    .loading-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: #9ca3af;
      animation: blink 1s infinite ease-in-out;
    }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; }
      40% { opacity: 1; }
    }

    /* ğŸ“Œ MODEL SELECT MODAL */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal {
      background: #1e293b;
      padding: 18px;
      border-radius: 12px;
      width: 300px;
      border: 1px solid rgba(148,163,184,0.4);
      text-align: center;
    }
    .modal h3 {
      margin-top: 0;
      font-size: 16px;
      color: #f1f5f9;
    }
    .modal select {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      margin-top: 8px;
      background: #0f172a;
      color: #e2e8f0;
    }
    .modal button {
      margin-top: 14px;
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #0f172a;
      font-weight: 600;
    }
  </style>
</head>
<body>

  <!-- ğŸ“Œ ëª¨ë¸ ì„ íƒ ëª¨ë‹¬ -->
  <div id="modelModal" class="modal-bg">
    <div class="modal">
      <h3>ëª¨ë¸ ì„ íƒ</h3>
      <select id="modelSelect">
        <option value="gpt-5-mini">gpt-5-mini (ê¸°ë³¸)</option>
        <option value="gpt-5">gpt-5</option>
        <option value="gpt-5.1-codex-mini">gpt-5.1-codex-mini</option>
        <option value="gpt-5-pro">gpt-5-pro</option>
      </select>
      <button onclick="confirmModel()">í™•ì¸</button>
    </div>
  </div>

  <div class="app">

    <!-- ì™¼ìª½: ì±„íŒ… ëª©ë¡ -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">ë‚´ ì±„íŒ…</div>
        <button class="sidebar-btn" id="newChatBtn">+ ìƒˆ ì±„íŒ…</button>
      </div>

      <ul class="chat-list" id="chatList"></ul>

      <div class="sidebar-footer">
        í´ë¦­í•´ì„œ ì „í™˜ Â· íœ´ì§€í†µìœ¼ë¡œ ì‚­ì œ
      </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ë©”ì¸ -->
    <main class="main">

      <div class="header">
        <div class="logo">mini-wrtn</div>
        <div class="badge">render prototype</div>
      </div>

      <div class="mode-select">
        ëª¨ë“œ:
        <label><input type="radio" name="mode" value="chat" checked> ì±„íŒ…</label>
        <label><input type="radio" name="mode" value="search"> ê²€ìƒ‰ + LLM</label>
      </div>

      <div id="log">
        <div class="system-line">
          ğŸ’¬ ì™¼ìª½ì—ì„œ ì±„íŒ…ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“¤ê³  ì§ˆë¬¸í•´ë³´ì„¸ìš”.
        </div>
      </div>

      <div id="loadingIndicator" class="loading-indicator hidden">
        <span>ğŸ¤– ìƒê° ì¤‘</span>
        <div class="loading-dot"></div>
        <div class="loading-dot"></div>
        <div class="loading-dot"></div>
      </div>

      <div class="input-row">
        <input id="msg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enter ë˜ëŠ” 'ë³´ë‚´ê¸°'ë¥¼ ëˆŒëŸ¬ìš”.">
        <button class="send-btn" id="sendBtn" onclick="send()">ë³´ë‚´ê¸°</button>
      </div>

    </main>
  </div>

<script>
/* -------------------------
     ê¸°ì¡´ ë³€ìˆ˜ / ì €ì¥ êµ¬ì¡°
------------------------- */
const STORAGE_KEY = "mini_wrtn_chats_v1";
let chats = [];     // { id, title, logText, model }
let currentChatId = null;

const chatListEl = document.getElementById("chatList");
const log = document.getElementById("log");
const msgInput = document.getElementById("msg");
const loadingIndicator = document.getElementById("loadingIndicator");
const sendBtn = document.getElementById("sendBtn");
const newChatBtn = document.getElementById("newChatBtn");

let isBusy = false;

/* -------------------------
     ëª¨ë¸ ì„ íƒ ëª¨ë‹¬
------------------------- */
const modal = document.getElementById("modelModal");
const modelSelect = document.getElementById("modelSelect");
let pendingNewChatId = null;

newChatBtn.addEventListener("click", () => {
  modal.style.display = "flex";
});

function confirmModel() {
  const id = String(Date.now());
  const selectedModel = modelSelect.value;

  const newChat = {
    id,
    title: "ìƒˆ ì±„íŒ…",
    logText: "ğŸ’¬ ìƒˆ ì±„íŒ…ì…ë‹ˆë‹¤. ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ ë³´ì„¸ìš”.\n",
    model: selectedModel
  };

  chats.unshift(newChat);
  currentChatId = id;

  saveChatsToStorage();
  renderChatList();
  selectChat(id);

  modal.style.display = "none";
}

/* -------------------------
     ì €ì¥ / ë¡œë”©
------------------------- */
function loadChatsFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) chats = JSON.parse(raw);
  } catch (e) {}

  if (!Array.isArray(chats) || chats.length === 0) {
    const id = String(Date.now());
    chats = [
      { id, title: "ìƒˆ ì±„íŒ…", logText: "ğŸ’¬ ìƒˆ ì±„íŒ…ì…ë‹ˆë‹¤.\n", model: "gpt-5-mini" }
    ];
    currentChatId = id;
    saveChatsToStorage();
  } else if (!currentChatId) {
    currentChatId = chats[0].id;
  }
}

function saveChatsToStorage() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
}

/* -------------------------
     ì±„íŒ… ëª©ë¡ ë Œë”ë§
------------------------- */
function renderChatList() {
  chatListEl.innerHTML = "";
  chats.forEach(chat => {
    const li = document.createElement("li");
    li.className = "chat-item" + (chat.id === currentChatId ? " active" : "");
    li.dataset.id = chat.id;

    const titleDiv = document.createElement("div");
    titleDiv.className = "chat-item-title";
    titleDiv.textContent = chat.title;

    const snippetDiv = document.createElement("div");
    snippetDiv.className = "chat-item-snippet";
    snippetDiv.textContent =
      (chat.logText || "").split("\n").find(t => t.trim()) || "ëŒ€í™” ì—†ìŒ";

    const del = document.createElement("button");
    del.textContent = "ğŸ—‘";
    del.style.background = "transparent";
    del.style.border = "none";
    del.style.cursor = "pointer";
    del.style.marginLeft = "4px";

    del.addEventListener("click", e => {
      e.stopPropagation();
      deleteChat(chat.id);
    });

    li.appendChild(titleDiv);
    li.appendChild(snippetDiv);
    li.appendChild(del);

    li.addEventListener("click", () => selectChat(chat.id));
    chatListEl.appendChild(li);
  });
}

function selectChat(id) {
  currentChatId = id;
  const chat = chats.find(c => c.id === id);
  log.textContent = chat.logText;
  renderChatList();
}

function deleteChat(id) {
  if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;

  const idx = chats.findIndex(c => c.id === id);
  chats.splice(idx, 1);

  if (chats.length === 0) {
    const id2 = String(Date.now());
    chats = [
      { id: id2, title: "ìƒˆ ì±„íŒ…", logText: "ğŸ’¬ ìƒˆ ì±„íŒ…ì…ë‹ˆë‹¤.\n", model: "gpt-5-mini" }
    ];
    currentChatId = id2;
  } else if (currentChatId === id) {
    currentChatId = chats[0].id;
  }

  saveChatsToStorage();
  renderChatList();
  selectChat(currentChatId);
}

/* -------------------------
     ë¡œë”© ì¸ë””ì¼€ì´í„°
------------------------- */
function setLoading(state) {
  isBusy = state;
  loadingIndicator.classList.toggle("hidden", !state);
  sendBtn.disabled = state;
  msgInput.disabled = state;
}

/* -------------------------
     ìœ í‹¸
------------------------- */
function appendLine(text) {
  const div = document.createElement("div");
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

/* -------------------------
     ë©”ì‹œì§€ ë³´ë‚´ê¸°
------------------------- */
async function send() {
  if (isBusy) return;

  const input = msgInput.value.trim();
  if (!input) return;

  const mode = document.querySelector("input[name=mode]:checked").value;
  const chat = chats.find(c => c.id === currentChatId);

  appendLine("ğŸ‘¤ ë‚˜: " + input);
  msgInput.value = "";

  setLoading(true);

  try {
    if (mode === "chat") {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: input,
          conversation_id: currentChatId,
          model: chat.model   // ğŸ“Œ ì¤‘ìš”! ì±„íŒ…ë°© ëª¨ë¸ ì „ë‹¬
        })
      });
      const data = await res.json();
      appendLine("ğŸ¤– AI: " + data.reply);

    } else {
      const res = await fetch("/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: input,
          conversation_id: currentChatId
        })
      });
      const data = await res.json();
      appendLine("ğŸ¤– AI(ê²€ìƒ‰): " + data.answer);
    }
  } catch (err) {
    appendLine("âš  ì˜¤ë¥˜: " + err);
  }

  const c = chats.find(x => x.id === currentChatId);
  c.logText = log.textContent;
  saveChatsToStorage();
  renderChatList();

  setLoading(false);
}

/* Enterë¡œ ì „ì†¡ */
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

/* ì´ˆê¸° ì‹¤í–‰ */
loadChatsFromStorage();
renderChatList();
selectChat(currentChatId);

</script>
</body>
</html>
